---

################################################################################
# Get the external IP address, from configuration file,
# or automatically through a script

- name: Install the required packages
  apt:
    name: '{{ ip_check_packages }}'
    state: present

- name: Copy the configuration file
  tags: scripts
  copy:
    src: external-ip.conf
    dest: /etc/external-ip.conf

- name: Copy the external IP address detection scripts
  tags: scripts
  copy:
    src: '{{ script }}'
    dest: '/usr/local/bin/{{ script }}'
    mode: 0755
  with_items:
    - external-ip
    - external-ip-check
  loop_control:
    loop_var: script

- name: Configure the daily IP address checking
  cron:
    hour: '0'
    minute: '0'
    name: External IP check
    job: /usr/local/bin/external-ip-check "$(grep EXTERNAL_IP /etc/homebox/external-ip | cut -f 2 -d '=')"
    cron_file: external-ip-check
    user: root

- name: Run the IP check once to get the current IP Address
  shell: >-
    /usr/local/bin/external-ip-check
  args:
    creates: /etc/homebox/external-ip
